# HPA config note
- Enable Aggregation Layer
```
sudo cp /etc/kubernetes/manifests/kube-apiserver.yaml /etc/kubernetes/manifests/kube-apiserver.yaml.backup

sudo nano /etc/kubernetes/manifests/kube-apiserver.yaml
```
Add these arguments to the spec.containers[0].command section:
```
- --enable-aggregator-routing=true
```
Result should be like this:
```
.....
spec:
  containers:
  - command:
    - kube-apiserver
    ...
    - --allow-privileged=true
    - --authorization-mode=Node,RBAC
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --enable-admission-plugins=NodeRestriction
    - --enable-bootstrap-token-auth=true
    ...
    - --enable-aggregator-routing=true
...
```
Then wait for kube-apiserver to restart. After that, verify with
```
# Check extension-apiserver-authentication configmap exists
kubectl get configmap extension-apiserver-authentication -n kube-system

# Check kube-apiserver logs for aggregation-related messages
kubectl logs -n kube-system kube-apiserver-$(hostname) | grep -i aggregat
```

- Verify Kubelet Authentication and Authorization
Nodes must have Webhook authentication and authorization enabled. In kubeadm, this is typically enabled by default, but verify in /var/lib/kubelet/config.yaml:
```
...
authentication:
  webhook:
    enabled: true
authorization:
  mode: Webhook
...
```
- Install Metrics server (only apply for kubeadm deployment)
```
# Apply the official metrics server
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# Patch it to use insecure TLS
kubectl patch deployment metrics-server -n kube-system --type='json' -p='[
  {
    "op": "add",
    "path": "/spec/template/spec/containers/0/args/-",
    "value": "--kubelet-insecure-tls"
  }
]'
```
- Verify
```
kubectl get apiservice v1beta1.metrics.k8s.io
kubectl -n kube-system get pod | grep metrics-server
kubectl logs -n kube-system deployment/metrics-server
```

