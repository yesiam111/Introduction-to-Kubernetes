# CEPH single node deployment
## Deployment
```bash
CEPH_RELEASE=19.2.2
curl --silent --remote-name --location https://download.ceph.com/rpm-${CEPH_RELEASE}/el9/noarch/cephadm
chmod +x cephadm
./cephadm add-repo --release tentacle
./cephadm install
cephadm install ceph-common
cephadm --image quay.io/ceph/ceph:v20 bootstrap --mon-ip 192.168.100.63 --single-host-default --initial-dashboard-user admin --initial-dashboard-password admin
ceph orch apply osd --all-available-devices
```
## Create RBD pool 
```
ceph osd pool create pool-1
ceph osd pool create pool-2
ceph osd pool create pool-3
ceph osd pool create pool-4

ceph auth get-or-create client.user-1 mon 'allow r' osd 'allow rwx pool=pool-1' -o user-1.keyring
ceph auth get-or-create client.user-2 mon 'allow r' osd 'allow rwx pool=pool-2' -o user-2.keyring
ceph auth get-or-create client.user-3 mon 'allow r' osd 'allow rwx pool=pool-3' -o user-3.keyring
ceph auth get-or-create client.user-4 mon 'allow r' osd 'allow rwx pool=pool-4' -o user-4.keyring

ceph auth print-key client.user-1
ceph auth print-key client.user-2
ceph auth print-key client.user-3
ceph auth print-key client.user-4
```

# Ceph CSI integration sample step

## Links

* <https://docs.ceph.com/en/latest/rbd/rbd-kubernetes/>

## Ceph CSI setup

### Config preparation
```
cat <<EOF > csi-config-map.yaml
---
apiVersion: v1
kind: ConfigMap
data:
  config.json: |-
    [
      {
        "clusterID": "<ceph_cluster_id>",
        "monitors": [
          "<mon_1_ip>:6789",
          "<mon_2_ip>:6789",
          "<mon_3_ip>:6789"
        ]
      }
    ]
metadata:
  name: ceph-csi-config
  namespace: <ceph-csi-deploy-namespace>
EOF
```

```
kubectl apply -f csi-config-map.yaml
```

```
cat <<EOF > csi-kms-config-map.yaml
---
apiVersion: v1
kind: ConfigMap
data:
  config.json: |-
    {}
metadata:
  name: ceph-csi-encryption-kms-config
  namespace: <ceph-csi-deploy-namespace>
EOF

cat <<EOF > ceph-config-map.yaml
---
apiVersion: v1
kind: ConfigMap
data:
  ceph.conf: |
    [global]
    auth_cluster_required = cephx
    auth_service_required = cephx
    auth_client_required = cephx
  # keyring is a required key and its value should be empty
  keyring: |
metadata:
  name: ceph-config
  namespace: <ceph-csi-deploy-namespace>
EOF
```

```
kubectl apply -f csi-kms-config-map.yaml
kubectl apply -f ceph-config-map.yaml
```
### Create CSI secret and config CEPH-CSI plugins
```
cat <<EOF > csi-rbd-secret.yaml
---
apiVersion: v1
kind: Secret
metadata:
  name: csi-rbd-secret
  namespace: <ceph-csi-deploy-namespace>
stringData:
  userID: <ceph-user-id>
  userKey: <ceph-user-secret-key>
EOF
```

```
kubectl apply -f csi-rbd-secret.yaml
```

```
wget https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-provisioner-rbac.yaml
sed -i.bak 's/namespace\:\ default/namespace\:\ <ceph-csi-deploy-namespace>/g' ./csi-provisioner-rbac.yaml
wget https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-nodeplugin-rbac.yaml
sed -i.bak 's/namespace\:\ default/namespace\:\ <ceph-csi-deploy-namespace>/g' ./csi-nodeplugin-rbac.yaml
wget https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-rbdplugin-provisioner.yaml
sed -i.bak 's/namespace\:\ default/namespace\:\ <ceph-csi-deploy-namespace>/g' ./csi-rbdplugin-provisioner.yaml
wget https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-rbdplugin.yaml
sed -i.bak 's/namespace\:\ default/namespace\:\ <ceph-csi-deploy-namespace>/g' ./csi-rbdplugin.yaml
```

```
kubectl apply -f csi-provisioner-rbac.yaml
kubectl apply -f csi-nodeplugin-rbac.yaml
kubectl apply -f csi-rbdplugin-provisioner.yaml
kubectl apply -f csi-rbdplugin.yaml
```

- Create storage class
```
cat <<EOF > csi-rbd-sc.yaml
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
   name: csi-rbd-sc
provisioner: rbd.csi.ceph.com
parameters:
   clusterID: <ceph-cluster-id>
   pool: <ceph-rbd-pool-name>
   imageFeatures: layering
   csi.storage.k8s.io/provisioner-secret-name: csi-rbd-secret
   csi.storage.k8s.io/provisioner-secret-namespace: <ceph-csi-deploy-namespace>
   csi.storage.k8s.io/controller-expand-secret-name: csi-rbd-secret
   csi.storage.k8s.io/controller-expand-secret-namespace: <ceph-csi-deploy-namespace>
   csi.storage.k8s.io/node-stage-secret-name: csi-rbd-secret
   csi.storage.k8s.io/node-stage-secret-namespace: <ceph-csi-deploy-namespace>
reclaimPolicy: Delete
allowVolumeExpansion: true
mountOptions:
   - discard
EOF
```

```
kubectl apply -f csi-rbd-sc.yaml

kubectl get sc
```


## Ceph CSI Snapshot
- Install additional K8S CSI component
```
git clone https://github.com/ceph/ceph-csi.git -b v3.14.1
cd ceph-csi
./scripts/install-snapshot.sh install
```

- Create snapshot class
`snapshotclass.yaml`
```
---
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: csi-rbdplugin-snapclass
driver: rbd.csi.ceph.com
parameters:
  clusterID: <cluster-id>
  csi.storage.k8s.io/snapshotter-secret-name: csi-rbd-secret
  csi.storage.k8s.io/snapshotter-secret-namespace: <ceph-csi-namespace>
deletionPolicy: Delete
```
`kubectl create -f snapshotclass.yaml`

- list snapshotclass
```
kubectl get volumesnapshotclass
```

- create snapshot

`snapshot.yaml`
```
---
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: rbd-pvc-snapshot
spec:
  volumeSnapshotClassName: csi-rbdplugin-snapclass
  source:
    persistentVolumeClaimName: raw-block-pvc
```

`kubectl create -f snapshot.yaml`

`kubectl get volumesnapshot`
